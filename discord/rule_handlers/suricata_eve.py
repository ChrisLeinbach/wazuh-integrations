from typing import List, Union
from copy import deepcopy
from rule_handlers.base_handler import BaseHandler


class SuricataEve(BaseHandler):

    """
    SuricataEve handles alerts generated by agents parsing Suricata's eve.json file.
    """

    alert_ids = ['86601']
    enabled = True

    def __init__(self, alert_data: dict):
        super().__init__(alert_data)

    def generate_fields(self) -> List[dict]:
        sig_field = deepcopy(self.base_field)
        sig_field["name"] = "Signature"
        sig_field["value"] = self.alert_data["data"]["alert"]["signature_id"]

        action_field = deepcopy(self.base_field)
        action_field["name"] = "Action"
        action_field["value"] = self.alert_data["data"]["alert"]["action"]

        severity_field = deepcopy(self.base_field)
        severity_field["name"] = "Severity"
        severity_field["value"] = self.alert_data["data"]["alert"]["severity"]

        src_ip_field = deepcopy(self.base_field)
        src_ip_field["name"] = "Source IP"
        src_ip_field["value"] = self.alert_data["data"]["flow"]["src_ip"]

        dst_ip_field = deepcopy(self.base_field)
        dst_ip_field["name"] = "Destination IP"
        dst_ip_field["value"] = self.alert_data["data"]["flow"]["dest_ip"]

        alert_data = [sig_field, action_field, severity_field, src_ip_field, dst_ip_field]

        if "http" in self.alert_data["data"].keys():
            http_host_field = deepcopy(self.base_field)
            http_host_field["name"] = "HTTP Host Name"
            http_host_field["value"] = self.alert_data["data"]["http"]["hostname"]
            alert_data.append(http_host_field)

            http_url_field = deepcopy(self.base_field)
            http_url_field["name"] = "HTTP URL"
            http_url_field["value"] = self.alert_data["data"]["http"]["url"]
            alert_data.append(http_url_field)

        return alert_data

    def generate_description(self) -> Union[str, None]:
        """ Default description is acceptably specific. """
        return None
